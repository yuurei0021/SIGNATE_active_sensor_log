# 20251120_08_model_comparison

## 目的
ベースラインモデル（20251120_05）とstairs改善モデル（20251120_07）のテストデータ予測確信度を比較し、stairs改善による他クラスへの影響を評価する。

## アプローチ
1. 両モデルのテストデータ予測確率（test_proba.csv）を読み込み
2. 各クラスの予測確信度統計量（平均、最小、中央値など）を計算
3. 低確信度サンプル（<0.9）を特定し、両モデル間で比較
4. 特に問題のあるサンプル（test_01014）を詳細分析

## 結果

### 全体的な比較

| クラス | メトリック | ベースライン | 改善版 | 変化 |
|--------|-----------|------------|--------|------|
| **STAIRS** | 低確信度(<0.9)件数 | 7件 | 0件 | **-7件** |
| | 最小確信度 | 70.36% | 95.25% | **+24.89%** |
| | 平均確信度 | 96.99% | 99.35% | **+2.36%** |
| **WALKING** | 低確信度(<0.9)件数 | 1件 | 1件 | ±0件 |
| | 最小確信度 | 86.62% | 62.13% | **-24.49%** |
| | 平均確信度 | 99.88% | 99.81% | -0.07% |
| **RUNNING** | 最小確信度 | 99.71% | 99.44% | -0.27% |
| | 平均確信度 | 99.99% | 99.93% | -0.06% |
| **IDLE** | ほぼ変化なし | - | - | - |

### 低確信度サンプルの詳細

#### STAIRS低確信度（ベースラインのみ）
- test_01841: 70.36%
- test_01370: 81.01%
- test_00073: 86.13%
- test_01159: 86.91%
- test_00226: 88.19%
- test_01045: 89.10%
- test_01745: 89.24%

**改善版ではすべて95%以上に改善**

#### WALKING低確信度（両モデル共通）

**test_01014の比較:**

| モデル | 予測 | idle | running | stairs | walking |
|--------|------|------|---------|--------|---------|
| ベースライン | walking | 0.28% | 0.66% | 12.44% | 86.62% |
| 改善版 | walking | 0.23% | 0.40% | 37.24% | 62.13% |

**重要な発見:**
- stairs確率が12.44% → 37.24%に**3倍増加**
- walking確率が86.62% → 62.13%に低下
- 予測クラスは両モデルとも**walking**（ただし正解ラベルは不明）

### モデル性能比較

| メトリック | ベースライン (05) | 改善版 (07) |
|-----------|-----------------|------------|
| OOF F1 Macro | 0.9950 | **0.9988** |
| Public LB F1 Macro | 1.0000 | 1.0000 |
| Stairs低確信度件数 | 7件 | **0件** |
| Walking最小確信度 | 86.62% | 62.13% |

## 分析と考察

### Stairs改善の効果
1. **劇的な改善**: 7件の低確信度サンプルをすべて解消
2. **最小確信度の大幅向上**: 70.36% → 95.25% (+24.89%)
3. **クラス重み5倍の効果**: stairsの決定境界が拡大し、予測が安定化

### 副作用: Walking予測への影響
1. **境界サンプルの確信度低下**: test_01014のwalking確率が86.62% → 62.13%
2. **原因**: stairsクラス重み5倍により、walkingとstairsの境界付近サンプルがstairsに引き寄せられた
3. **影響範囲**: たった1件のみ（全540件中0.2%）
4. **リスク**: 正解ラベルが不明なため、確信度低下が誤分類につながる可能性もある（両モデルともPublic LBで100%達成しているが、test_01014の正解は不明）

### Running予測への影響
1. **最小確信度の若干低下**: 99.71% → 99.44% (-0.27%)
2. **影響は軽微**: 平均確信度はほぼ変化なし

## 結論

### モデル選択の考察

**改善版（20251120_07）を推奨する根拠:**
1. **OOF scoreが優秀**: 0.9988 vs 0.9950 (+0.0038)
   - 訓練データでの汎化性能が高い
   - Private LBではOOF scoreが高いモデルが有利な傾向
2. **Stairs予測の安定性**: 7件の低確信度を完全に解消
   - ベースラインで70.36%だったサンプルが95.25%に改善
3. **Public LBで完璧**: 両モデルとも100%達成

**ベースライン（20251120_05）を検討する根拠:**
1. **Walking予測の安定性**: 最小確信度86.62% vs 62.13%
   - test_01014の正解が不明なため、確信度低下がリスクとなる可能性
   - もしtest_01014が実際にstairsなら改善版が正しいが、walkingなら悪化
2. **過学習リスクの回避**: stairsクラス重み調整が過剰な可能性

### 最終推奨

**決定的な判断は困難**だが、以下の理由で改善版を第一候補とする：
- OOF scoreの優位性（+0.0038）
- Stairs低確信度の完全解消（7件→0件）
- Walking影響は1件のみ（全540件中0.2%）

ただし、test_01014の正解が不明である以上、確実性は保証できない。

### リスク管理戦略
**両方の予測ファイルを必ず保持**し、Private LB結果を確認してから最終決定：
1. **第一候補**: 20251120_07_stairs_improvement（改善版）
2. **バックアップ**: 20251120_05_baseline_lightgbm（ベースライン）
3. Private LB結果次第で、どちらが優れているか判断する

## 実行方法

```bash
cd experiments/20251120_08_model_comparison
uv run python analysis.py
```

## 出力ファイル
- `comparison_results.csv`: 各クラスの統計量比較
- `low_confidence_samples.csv`: 低確信度サンプルの詳細

## 次のステップ
1. 改善版（20251120_07）をPrivate LBに提出
2. Private LB結果を確認
3. 必要に応じてベースライン（20251120_05）と比較
4. 最終的な提出を決定
